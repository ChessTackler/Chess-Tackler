<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chess Tackler</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
    }
    .header {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      width: 100%;
      max-width: 600px;
      background-color: #333;
      color: white;
    }
    .header img {
      width: 32px;
      height: 32px;
      margin-right: 10px;
    }
    .header h1 {
      font-size: 20px;
      margin: 0;
    }
    .history {
      width: 95%;
      max-width: 400px;
      margin: 10px auto;
      padding: 5px;
      background-color: #eee;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
      text-align: center;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(8, 40px);
      grid-template-rows: repeat(8, 40px);
      border: 2px solid #333;
      margin: 10px 0;
    }
    .square {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .light { background-color: #f0d9b5; }
    .dark { background-color: #b58863; }
    .highlight { outline: 2px solid yellow; }
    .piece {
      max-width: 90%;
      max-height: 90%;
      cursor: grab;
      user-select: none;
    }
    .checkmate-message {
      font-size: 18px;
      font-weight: bold;
      color: red;
      margin-top: 10px;
    }
    .nav-buttons {
      margin: 8px;
    }
    .nav-buttons button {
      background-color: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      margin: 0 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="CT logo.png" alt="CT Logo" />
    <h1>Chess Board – Chess Tackler</h1>
  </div>

  <div class="history" id="moveHistory"></div>
  <div class="board" id="chessBoard"></div>
  <div class="nav-buttons">
    <button id="prevBtn" title="Previous Move">◀</button>
    <button id="nextBtn" title="Next Move">▶</button>
  </div>
  <div class="checkmate-message" id="checkmateMessage"></div>
  <audio id="checkmateAudio" src="correct.mp3" preload="auto"></audio>

  <script>
    const board = document.getElementById("chessBoard");
    const moveHistoryDiv = document.getElementById("moveHistory");
    const checkmateMessage = document.getElementById("checkmateMessage");
    const audio = document.getElementById("checkmateAudio");

    let boardState = [];
    let moveHistory = [];
    let currentTurn = 'w';
    let selected = null;
    let gameOver = false;
    let historyIndex = -1;
    let castlingRights = { w: { K: true, Q: true }, b: { K: true, Q: true } };

    function initializeBoard() {
      const initial = [
        ["bR", "bN", "bB", "bQ", "bK", "bB", "bN", "bR"],
        Array(8).fill("bP"),
        ...Array(4).fill(Array(8).fill(null)),
        Array(8).fill("wP"),
        ["wR", "wN", "wB", "wQ", "wK", "wB", "wN", "wR"],
      ];
      boardState = JSON.parse(JSON.stringify(initial));
      moveHistory = [];
      historyIndex = -1;
    }

    function renderBoard() {
      board.innerHTML = "";
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          const square = document.createElement("div");
          square.className = `square ${(r + c) % 2 === 0 ? "light" : "dark"}`;
          square.dataset.row = r;
          square.dataset.col = c;

          const piece = boardState[r][c];
          if (piece) {
            const img = document.createElement("img");
            img.src = `${piece}.png`;
            img.className = "piece";
            img.draggable = true;
            img.ondragstart = (e) => {
              e.dataTransfer.setData("fromRow", r);
              e.dataTransfer.setData("fromCol", c);
            };
            square.appendChild(img);
          }

          square.onclick = () => onSquareClick(r, c);
          square.ondragover = e => e.preventDefault();
          square.ondrop = e => {
            e.preventDefault();
            const fromRow = parseInt(e.dataTransfer.getData("fromRow"));
            const fromCol = parseInt(e.dataTransfer.getData("fromCol"));
            tryMove(fromRow, fromCol, r, c);
          };

          board.appendChild(square);
        }
      }
    }

    function onSquareClick(r, c) {
      if (gameOver) return;
      const piece = boardState[r][c];
      if (selected) {
        const [sr, sc] = selected;
        if (boardState[sr][sc] && boardState[sr][sc][0] === currentTurn &&
            isLegalMove(boardState[sr][sc], sr, sc, r, c)) {
          tryMove(sr, sc, r, c);
          selected = null;
        } else {
          selected = null;
        }
      } else if (piece && piece[0] === currentTurn) {
        selected = [r, c];
      }
    }

    function tryMove(fromRow, fromCol, toRow, toCol) {
      if (gameOver) return;
      const piece = boardState[fromRow][fromCol];
      if (!piece || piece[0] !== currentTurn) return;
      if (!isLegalMove(piece, fromRow, fromCol, toRow, toCol)) return;

      const prevBoard = JSON.parse(JSON.stringify(boardState));
      boardState[toRow][toCol] = piece;
      boardState[fromRow][fromCol] = null;

      moveHistory = moveHistory.slice(0, historyIndex + 1);
      moveHistory.push({ board: prevBoard, turn: currentTurn });
      historyIndex++;

      currentTurn = currentTurn === 'w' ? 'b' : 'w';
      renderBoard();
      updateHistoryText();

      if (isCheckmate(currentTurn)) {
        checkmateMessage.textContent = `Checkmate! Player ${currentTurn === 'w' ? 'Black' : 'White'} wins.`;
        alert("Checkmate!");
        audio.play();
        gameOver = true;
      }
    }

    function updateHistoryText() {
      moveHistoryDiv.textContent = `Moves: ${historyIndex + 1}`;
    }

    function isLegalMove(piece, fr, fc, tr, tc) {
      const target = boardState[tr][tc];
      if (target && target[0] === piece[0]) return false;
      const dr = tr - fr, dc = tc - fc;
      switch (piece[1]) {
        case 'P':
          const dir = piece[0] === 'w' ? -1 : 1;
          const startRow = piece[0] === 'w' ? 6 : 1;
          if (dc === 0 && !target) {
            if (dr === dir || (dr === 2 * dir && fr === startRow && !boardState[fr + dir][fc])) return true;
          } else if (Math.abs(dc) === 1 && dr === dir && target && target[0] !== piece[0]) return true;
          break;
        case 'R':
          if (dr === 0 || dc === 0) return isPathClear(fr, fc, tr, tc);
          break;
        case 'N':
          if ((Math.abs(dr) === 2 && Math.abs(dc) === 1) || (Math.abs(dr) === 1 && Math.abs(dc) === 2)) return true;
          break;
        case 'B':
          if (Math.abs(dr) === Math.abs(dc)) return isPathClear(fr, fc, tr, tc);
          break;
        case 'Q':
          if (dr === 0 || dc === 0 || Math.abs(dr) === Math.abs(dc)) return isPathClear(fr, fc, tr, tc);
          break;
        case 'K':
          if (Math.abs(dr) <= 1 && Math.abs(dc) <= 1) return true;
          break;
      }
      return false;
    }

    function isPathClear(fr, fc, tr, tc) {
      const dr = Math.sign(tr - fr);
      const dc = Math.sign(tc - fc);
      let r = fr + dr, c = fc + dc;
      while (r !== tr || c !== tc) {
        if (boardState[r][c]) return false;
        r += dr;
        c += dc;
      }
      return true;
    }

    function isCheckmate(color) {
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          const piece = boardState[r][c];
          if (piece && piece[0] === color) {
            for (let tr = 0; tr < 8; tr++) {
              for (let tc = 0; tc < 8; tc++) {
                const backup = boardState[tr][tc];
                const original = boardState[r][c];
                if (isLegalMove(piece, r, c, tr, tc)) {
                  boardState[tr][tc] = piece;
                  boardState[r][c] = null;
                  const kingSafe = !isKingInCheck(color);
                  boardState[r][c] = original;
                  boardState[tr][tc] = backup;
                  if (kingSafe) return false;
                }
              }
            }
          }
        }
      }
      return true;
    }

    function isKingInCheck(color) {
      let kr = -1, kc = -1;
      for (let r = 0; r < 8; r++)
        for (let c = 0; c < 8; c++)
          if (boardState[r][c] === color + 'K') [kr, kc] = [r, c];

      const opponent = color === 'w' ? 'b' : 'w';
      for (let r = 0; r < 8; r++)
        for (let c = 0; c < 8; c++)
          if (boardState[r][c]?.[0] === opponent)
            if (isLegalMove(boardState[r][c], r, c, kr, kc)) return true;

      return false;
    }

    document.getElementById("prevBtn").onclick = () => {
      if (historyIndex >= 0) {
        const state = moveHistory[historyIndex];
        boardState = JSON.parse(JSON.stringify(state.board));
        currentTurn = state.turn;
        historyIndex--;
        renderBoard();
        updateHistoryText();
        gameOver = false;
        checkmateMessage.textContent = "";
      }
    };

    document.getElementById("nextBtn").onclick = () => {
      if (historyIndex + 1 < moveHistory.length) {
        historyIndex++;
        const state = moveHistory[historyIndex];
        boardState = JSON.parse(JSON.stringify(state.board));
        currentTurn = state.turn === 'w' ? 'b' : 'w';
        renderBoard();
        updateHistoryText();
      }
    };

    initializeBoard();
    renderBoard();
    updateHistoryText();
  </script>
</body>
</html>